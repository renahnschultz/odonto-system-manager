<!DOCTYPE html>
<html
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

<ui:composition template="/template/template_geral.xhtml">
	<ui:define name="title">#{msgs['odontograma']}</ui:define>
	<ui:define name="card">
		<ui:param
			name="bean"
			value="#{odontogramaBean}" />
		<div class="ui-datatable-header ui-widget-header ui-corner-top">
			<div class="ui-g">
				<div class="ui-g-4"></div>
				<div
					class="ui-g-4"
					style="text-align: center;">#{msgs['odontograma']}</div>
				<div class="ui-g-4"></div>
			</div>
		</div>
		<div
			class="ui-fluid"
			style="padding: 10px;">
			<h:form
				id="formOdontograma"
				prependId="false">
				<h:inputHidden
					id="hiddenX"
					value="#{bean.marcacao.posX}" />
				<h:inputHidden
					id="hiddenY"
					value="#{bean.marcacao.posY}" />
				<h:inputHidden
					id="cor"
					value="#{bean.marcacao.cor}" />
				<h:inputHidden
					id="denteId"
					value="#{bean.denteId}" />
				<p:remoteCommand
					id="processoDeCoordenadas"
					name="processarCoordenadas"
					process="@form"
					action="#{bean.processarMarcacao()}"
					update="panelMarcacoes"></p:remoteCommand>
				<h:panelGroup
					rendered="#{bean.odontograma eq null}"
					style="text-align:center;">
					<h:outputText
						styleClass="texto-sem-odontograma"
						value="#{msgs['paciente.sem.odontograma']}"></h:outputText>
					<p:commandButton
						value="#{msgs['novo.odontograma']}"
						styleClass="btn btn-success"
						process="@this"
						action="#{bean.criarNovoOdontograma}"
						icon="fa fa-plus"></p:commandButton>
				</h:panelGroup>
				<h:panelGroup
					rendered="#{bean.odontograma ne null}"
					styleClass="ui-g">
					<div
						id="divOdontograma"
						class="ui-g-8"
						style="border-right: 1px solid #eee;">
						<p:repeat
							var="dente"
							value="#{bean.odontograma.dentes}">
							<canvas
								id="canvas#{dente.dente.id}"
								class="canvas-odontograma"
								width="#{dente.dente.percentualTamanho()}"
								height="40vh"
								style="cursor: crosshair;background:url(../images/odontograma/#{dente.dente.img});background-position:center;background-repeat: no-repeat;background-size: 100%;"></canvas>
						</p:repeat>
					</div>
					<div class="ui-g-4">
						<div
							class="ui-g-12 ui-g"
							style="height: 20%;">
							<div class="ui-g-2">
								<p:graphicImage
									value="/images/user.png"
									style="position:relative;display:block"
									styleClass="mx-auto my-auto"
									width="60"
									height="60" />
							</div>
							<div class="ui-g-10">
								<p:panelGrid
									columns="1"
									layout="grid">
									<h:outputText
										style="font-size: 22px;font-weight: bold;"
										value="#{bean.odontograma.paciente.nome} #{bean.odontograma.paciente.sobrenome}" />
									<h:outputText
										value="#{msgs['idade']}: #{bean.odontograma.paciente.idade}" />
								</p:panelGrid>
							</div>
						</div>
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 28px; font-weight: bold; color: #3c3c3c;">
							#{msgs['ferramentas']}</div>
						<div
							class="ui-g-12 ui-g"
							style="padding: 0px;">
							<p:outputPanel
								id="marcarAusente"
								class="ui-g-2"
								style="font-size: 28px; color: #444;">
								<span
									class="my-auto mx-auto fa fa-minus-square"
									style="display: table; position: relative;" />
							</p:outputPanel>
							<p:tooltip
								id="marcarAusenteTooltip"
								for="marcarAusente"
								value="#{msgs['marcar.dente.ausente']}"
								position="bottom" />
							<p:outputPanel
								id="marcarProtese"
								class="ui-g-2"
								style="font-size: 28px; color: #444;">
								<span
									class="my-auto mx-auto fa fa-wrench"
									style="display: table; position: relative;" />
							</p:outputPanel>
							<p:tooltip
								id="marcarProteseTooltip"
								for="marcarProtese"
								value="#{msgs['marcar.dente.protese']}"
								position="bottom" />
							<p:outputPanel
								id="marcar"
								class="ui-g-2"
								style="font-size: 28px; color: #444;">
								<span
									class="my-auto mx-auto fa fa-circle"
									style="display: table; position: relative;" />
							</p:outputPanel>
							<p:tooltip
								id="marcarTooltip"
								for="marcar"
								value="#{msgs['realizar.marcacao']}"
								position="bottom" />
						</div>
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 28px; font-weight: bold; color: 3c3c3c;">
							#{msgs['marcacoes']}</div>
						<p:outputPanel
							id="panelMarcacoes"
							style="max-height: 45vh;overflow-y: scroll;"
							class="ui-g-12 ui-g marcacoes">
							<p:repeat
								var="marcacao"
								varStatus="status"
								value="#{bean.odontograma.marcacoes}">
								<div
									class="marcacao ui-g-12 ui-g"
									onmouseout="removerDestaque(#{marcacao.posX},#{marcacao.posY},#{marcacao.dente.dente.id})"
									onmouseover="destacarMarcacao(#{marcacao.posX},#{marcacao.posY},#{marcacao.dente.dente.id})">
									<div class="ui-g-2">
										<div
											class="circulo-marcacao mx-auto my-auto"
											style="background: #{marcacao.cor};"></div>
									</div>
									<p:outputPanel class="ui-material ui-g-7">
										<h:outputText
											value="#{marcacao.nome}"
											style="font-size: 18px;" />
										<br />
										<h:outputText
											value="#{marcacao.dente.dente.descricao}"
											style="color: #979797;" />
										<h:outputText
											value="#{marcacao.dataHora}"
											style="color: #979797; float:right;">
											<f:convertDateTime pattern="dd/MM/yy HH:mm" />
										</h:outputText>
									</p:outputPanel>
									<div
										class="ui-g-3 ui-g"
										style="padding: 0px;">
										<p:commandLink
											styleClass="ui-g-6"
											actionListener="#{bean.editarMarcacao(marcacao)}"
											oncomplete="PF('dialogMarcacao').show()"
											update="formDialogMarcacao"
											style="font-size: 28px; color: #444;">
											<span
												class="my-auto mx-auto fa fa-pencil"
												style="display: table; position: relative;" />
										</p:commandLink>
										<div
											class="ui-g-6"
											onclick="removerMarcacao(#{marcacao.posX},#{marcacao.posY},#{marcacao.dente.dente.id})"
											style="font-size: 28px; color: #f44336;">
											<span
												class="my-auto mx-auto fa fa-times"
												style="display: table; position: relative;" />
										</div>
									</div>
								</div>
							</p:repeat>
						</p:outputPanel>
					</div>
				</h:panelGroup>
			</h:form>
			<p:dialog
				id="dialogMarcacao"
				widgetVar="dialogMarcacao"
				modal="true"
				width="80vw"
				draggable="false"
				resizable="false"
				header="Editar marcacao">
				<h:form
					id="formDialogMarcacao"
					styleClass="ui-g"
					prependId="false">
					<div class="ui-g-4">
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 28px; font-weight: bold; color: #3c3c3c;">
							#{msgs['informacoes']}</div>
						<div class="ui-g-2">
							<div
								class="circulo-marcacao mx-auto my-auto"
								style="background: #{bean.marcacao.cor};"></div>
						</div>
						<div class="ui-g-10">
							<div class="ui-material">
								<p:inputText
									id="nomeMarcacao"
									required="true"
									placeholder="#{msgs['nome']}"
									value="#{bean.marcacao.nome}"></p:inputText>
								<p:outputLabel
									value="#{msgs['nome']}"
									for="nomeMarcacao"></p:outputLabel>
							</div>
						</div>
						<div class="ui-g-12">
							<div class="ui-material">
								<p:inputTextarea
									style="border: none;"
									value="#{bean.marcacao.descricao}"
									rows="4"
									id="descricaoMarcacao">
								</p:inputTextarea>
								<p:outputLabel
									value="#{msgs['descricao']}"
									for="descricaoMarcacao"></p:outputLabel>
							</div>
						</div>
					</div>
					<div
						class="ui-g-4"
						style="border-left: 1px solid #eee;">
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 28px; font-weight: bold; color: #3c3c3c;">
							#{msgs['servicos']}
							<p:commandButton
								value="#{msgs['adicionar.servico']}"
								icon="fa fa-plus"
								styleClass="btn btn-primary"
								style="width: auto;float:right;"></p:commandButton>
						</div>
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 18px; font-weight: bold; color: #676767;">
							<h:outputText
								value="#{msgs['total']}"
								style="float:left"></h:outputText>
							<h:outputText
								value="R$ 126,50"
								style="float:right"></h:outputText>
						</div>
					</div>
					<div
						class="ui-g-4"
						style="border-left: 1px solid #eee;">
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 28px; font-weight: bold; color: #3c3c3c;">
							#{msgs['comentarios']}</div>
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 28px; font-weight: bold; color: #3c3c3c;">
							#{msgs['comentarios']}</div>
						<div
							class="ui-g-12"
							style="padding: 0px; font-size: 28px; font-weight: bold; color: #3c3c3c;">
							#{msgs['comentarios']}</div>
					</div>
					<div
						class="ui-g-12"
						style="text-align: center;">
						<p:commandButton
							value="#{msgs['salvar']}"
							icon="fa fa-check"
							action="#{bean.salvar()}"
							onstart="PF('statusDialog').show();"
							oncomplete="PF('statusDialog').hide();PF('dialogMarcacao').hide();"
							styleClass="btn btn-success"
							style="width: auto;margin:auto;"></p:commandButton>
						<p:button
							value="#{msgs['cancelar']}"
							icon="fa fa-times"
							onclick="PF('dialogMarcacao').hide();"
							styleClass="btn btn-danger"
							style="width: auto;margin:auto;margin-left: 10px;"></p:button>
					</div>
				</h:form>
			</p:dialog>
		</div>
		<script type="text/javascript">
        //<![CDATA[
        
	        $(document).ready(sizingCanvas());
	        
			var pointSize = 4;
			var corPadrao = "#333333";
			var corDestaque = "#ffab00";

	        function destacarMarcacao(x, y, id){
	        	drawCoordinates(x,y,'canvas' + id, true);
		    }

	        function removerDestaque(x, y, id){
	        	limparRetangulo(x,y,'canvas' + id);
	        	drawCoordinates(x,y,'canvas' + id, false);
		    }

	        function removerMarcacao(x, y, id){
	        	limparRetangulo(x,y,'canvas' + id);
	        	$('#hiddenX').val(x);
			    $('#hiddenY').val(y);
			    $('#cor').val('#333333');
			    $('#denteId').val(id.replace('canvas', ''));
			    processarCoordenadas();
	        }

		    function limparRetangulo(x, y, id){
		    	var ctx = document.getElementById(id).getContext("2d");
		    	var tam = pointSize + 1;
		    	ctx.beginPath();
		    	ctx.clearRect(x - tam - 1, y - tam - 1, tam * 2 + 2, tam * 2 + 2);
		    	ctx.closePath();
			}
	
	        function sizingCanvas(){
	            $('.canvas-odontograma').each(function (){
					var largura = $(this).attr("width").replace('%', '');
					var pxLargura = $('#divOdontograma').width() * (largura / 100);
					$(this).attr("width", pxLargura);
					$(this).attr("height", $(window).height() * 0.4);
	            });
	        }
	        
	        $(document).on('click', ".canvas-odontograma", function(e){
			     getPosition(e, $(this).attr('id')); 
			});
			
			
			function getPosition(event, id){
				var canvas = document.getElementById(id);
			     var rect = canvas.getBoundingClientRect();
			     var x = event.clientX - rect.left;
			     var y = event.clientY - rect.top;
			        
			     drawCoordinates(x,y,id, false);
			     $('#hiddenX').val(x);
			     $('#hiddenY').val(y);
			     $('#cor').val('#333333');
			     $('#denteId').val(id.replace('canvas', ''));
			     processarCoordenadas();
			}
			
			function drawCoordinates(x,y,id, stroke){	
			  	var ctx = document.getElementById(id).getContext("2d");
			  	if(stroke){
				  	ctx.strokeStyle = corPadrao; // Red color
			  	}
			  	ctx.fillStyle = !stroke ? corPadrao : corDestaque; // Red color
			    ctx.beginPath();
			    ctx.arc(x, y, stroke ? pointSize + 1 : pointSize, 0, Math.PI * 2, true);
			    ctx.fill();
			  	if(stroke){
				    ctx.stroke();
			  	}
			}

			function imprimirMarcacoes(){
				$('.marcacao').each(function (){
					var chamada = $(this).attr('onmouseover');
					chamada = chamada.replace('destacarMarcacao(', '');
					chamada = chamada.replace(')', '');
					var dados = chamada.split(',');
					drawCoordinates(dados[0].trim(), dados[1].trim(), 'canvas' + dados[2].trim(), false)
				});
			}

			imprimirMarcacoes();

        //]]>
		</script>
	</ui:define>
</ui:composition>
</html>